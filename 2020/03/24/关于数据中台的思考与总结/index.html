<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/miaowenting.gitee.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/miaowenting.gitee.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/miaowenting.gitee.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/miaowenting.gitee.io/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/miaowenting.gitee.io/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/miaowenting.gitee.io/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/miaowenting.gitee.io/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/miaowenting.gitee.io/atom.xml" title="Matty's Blog" type="application/atom+xml">






<meta name="description" content="本文将总结下离线平台的相关实现。Flink平台化需要改进的点等等。">
<meta property="og:type" content="article">
<meta property="og:title" content="关于数据中台的思考与总结">
<meta property="og:url" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/index.html">
<meta property="og:site_name" content="Matty&#39;s Blog">
<meta property="og:description" content="本文将总结下离线平台的相关实现。Flink平台化需要改进的点等等。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E8%8B%8F%E5%AE%81%E7%A6%BB%E7%BA%BF%E5%B9%B3%E5%8F%B0%E4%BA%A7%E5%93%81%E5%8A%9F%E8%83%BD%E5%9B%BE.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E8%8B%8F%E5%AE%81%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E5%9B%BE.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E8%8B%8F%E5%AE%81%E7%A6%BB%E7%BA%BF%E5%B9%B3%E5%8F%B0%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E8%8B%8F%E5%AE%81%E5%8D%8E%E4%BD%97%E5%B9%B3%E5%8F%B0%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E8%AF%8A%E6%96%AD.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E7%9B%91%E6%8E%A7%E8%AE%BE%E8%AE%A1_%E7%BE%8E%E5%9B%A2%E7%82%B9%E8%AF%84.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%9B%BE_bilibili.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E5%B9%B3%E5%8F%B0%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%E5%9B%BE_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E4%BB%BB%E5%8A%A1%E8%B0%83%E8%AF%95_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E6%97%A5%E5%BF%97%E6%A3%80%E7%B4%A2_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E7%9B%91%E6%8E%A7_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E6%8A%A5%E8%AD%A6_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93_%E7%BD%91%E6%98%93.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E6%95%B0%E4%BB%93%E5%B8%B8%E7%94%A8%E5%88%86%E5%B1%82.png">
<meta property="og:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A8%A1%E5%9E%8B.png">
<meta property="og:updated_time" content="2020-03-25T09:53:21.897Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于数据中台的思考与总结">
<meta name="twitter:description" content="本文将总结下离线平台的相关实现。Flink平台化需要改进的点等等。">
<meta name="twitter:image" content="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/%E8%8B%8F%E5%AE%81%E7%A6%BB%E7%BA%BF%E5%B9%B3%E5%8F%B0%E4%BA%A7%E5%93%81%E5%8A%9F%E8%83%BD%E5%9B%BE.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/miaowenting.gitee.io/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/">





  <title>关于数据中台的思考与总结 | Matty's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/miaowenting.gitee.io/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matty's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/miaowenting.gitee.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/miaowenting.gitee.io/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/miaowenting.gitee.io/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/miaowenting.gitee.io/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/miaowenting.gitee.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://miaowenting.gitee.io/miaowenting.gitee.io/miaowenting.gitee.io/2020/03/24/关于数据中台的思考与总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="miaowenting">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/miaowenting.gitee.io/images/2.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matty's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">关于数据中台的思考与总结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-24T20:52:27+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/miaowenting.gitee.io/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文将总结下离线平台的相关实现。<br>Flink平台化需要改进的点等等。</p>
<a id="more"></a>

<h2 id="离线平台"><a href="#离线平台" class="headerlink" title="离线平台"></a>离线平台</h2><h3 id="苏宁"><a href="#苏宁" class="headerlink" title="苏宁"></a>苏宁</h3><p><a href="https://www.infoq.cn/article/suning-big-data" target="_blank" rel="noopener">苏宁大数据离线任务开发调度平台实践</a><br><a href="https://www.infoq.cn/article/xTvBg1_9iUL0z5Pjf0Os" target="_blank" rel="noopener">苏宁大数据离线任务开发调度平台实践：任务调度模块架构设计</a></p>
<p>苏宁离线平台产品功能图：<br><img src="%E8%8B%8F%E5%AE%81%E7%A6%BB%E7%BA%BF%E5%B9%B3%E5%8F%B0%E4%BA%A7%E5%93%81%E5%8A%9F%E8%83%BD%E5%9B%BE.png" alt></p>
<p>苏宁调度模块功能图：<br><img src="%E8%8B%8F%E5%AE%81%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E5%9B%BE.png" alt></p>
<p>苏宁离线平台整体架构图：<br><img src="%E8%8B%8F%E5%AE%81%E7%A6%BB%E7%BA%BF%E5%B9%B3%E5%8F%B0%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt></p>
<p>跨任务流依赖的实现：<br>FTP事件机制，即在 FTP 服务器上建立标识文件，一个事件对应一个标识文件地址，当 FTP 服务器上的标识文件生成的时候，我们认为业务系统已经完成作业，需要触发平台任务执行。</p>
<p>“华佗”平台，实施任务诊断：<br><img src="%E8%8B%8F%E5%AE%81%E5%8D%8E%E4%BD%97%E5%B9%B3%E5%8F%B0%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E8%AF%8A%E6%96%AD.png" alt></p>
<p>立即触发的任务，放入DelayQueue的队列头部<br>周期调度的任务，使用Quartz<br>依赖触发的任务，使用zk，各个子节点监听自己的父节点，所有父节点执行完毕则可触发执行</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="数据治理"><a href="#数据治理" class="headerlink" title="数据治理"></a>数据治理</h4><h4 id="数据质量"><a href="#数据质量" class="headerlink" title="数据质量"></a>数据质量</h4><h4 id="血缘"><a href="#血缘" class="headerlink" title="血缘"></a>血缘</h4><h4 id="元数据管理"><a href="#元数据管理" class="headerlink" title="元数据管理"></a>元数据管理</h4><h4 id="资产标签"><a href="#资产标签" class="headerlink" title="资产标签"></a>资产标签</h4><h4 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h4><h2 id="实时平台"><a href="#实时平台" class="headerlink" title="实时平台"></a>实时平台</h2><h3 id="实时接入"><a href="#实时接入" class="headerlink" title="实时接入"></a>实时接入</h3><h3 id="实时计算"><a href="#实时计算" class="headerlink" title="实时计算"></a>实时计算</h3><h4 id="美团点评"><a href="#美团点评" class="headerlink" title="美团点评"></a>美团点评</h4><p><img src="%E7%9B%91%E6%8E%A7%E8%AE%BE%E8%AE%A1_%E7%BE%8E%E5%9B%A2%E7%82%B9%E8%AF%84.png" alt></p>
<p>使用了Grafana，可以内嵌到自己的平台。</p>
<h4 id="bilibili"><a href="#bilibili" class="headerlink" title="bilibili"></a>bilibili</h4><p> SQL化编程</p>
<p> DAG拖拽编程</p>
<p> 一体化托管运维</p>
<p>实时平台由实时传输和实时计算两部分组成，平台底层统一管理元数据、血缘、权限以及作业运维等。实时传输主要负责将数据传入到大数据体系中。实时计算基于 BSQL 提供各种应用场景支持。</p>
<p>如下图所示，实时传输有 APP 日志、数据库 Binlog、服务端日志或系统日志。bilibili 内部的 Lancer 系统解决数据落地到 Kafka 或 HDFS。计算体系主要围绕 Saber 构建一套 BSQL，底层基于 YARN 进行调度管理。</p>
<p>上层核心基于 Flink 构建运行池。再向上一层满足多种维表场景，包括 MySQL、Redis、HBase。状态（State）部分在 RocksDB 基础上，还扩展了 MapDB、Redis。Flink 需要 IO 密集是很麻烦的问题，因为 Flink 的资源调度体系内有内存和 CPU，但 IO 单位未做统一管理。当某一个作业对 IO 有强烈的需求时，需要分配很多以 CPU 或内存为单位的资源，且未必能够很好的满足 IO 的扩展。所以本质上 bilibili 现阶段是将 IO 密集的资源的 State 转移到 Redis 上做缓解。数据经过 BSQL 计算完成之后传输到实时数仓，如 Kafka、HBase、ES 或 MySQL、TiDB。最终到 AI 或 BI、报表以及日志中心。<br><img src="%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%9B%BE_bilibili.png" alt></p>
<h5 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h5><ul>
<li>AI工程方向，解决了广告、搜索、推荐的流式Joiner和维表Joiner</li>
<li>实时计算的特征支持，支持 Player 以及 CDN 的质量监控。包括直播、PCU、卡顿率、CDN 质量等；</li>
<li>用户增长，即如何借助实时计算进行渠道分析、调整渠道投放效果；</li>
<li>实时 ETL，包括 Boss 实时播报、实时大屏、看板等。</li>
</ul>
<h4 id="网易"><a href="#网易" class="headerlink" title="网易"></a>网易</h4><p>目前网易流计算覆盖了绝大多数场景，包括广告、电商大屏、ETL、数据分析、推荐、风控、搜索、直播等。</p>
<h5 id="事件管理"><a href="#事件管理" class="headerlink" title="事件管理"></a>事件管理</h5><p>对于分布式平台的任务操作而言，当前任务启动过程中只允许一个人操作，而不允许两个人同时操作，这就需要以下几个模块来共同配合：</p>
<ul>
<li>Server：事件执行的发起者，接受事件的请求，进行数据校验，拼装，将事件发送给 Kernel 执行。</li>
<li>Kernel：事件具体逻辑的执行者，根据请求向集群发送指令(Shell 脚本方式)。</li>
<li>Admin：事件执行结果的确认者，根据事件类型，获取事件的最终结果，保证结果的正确性。</li>
</ul>
<p><img src="%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86_%E7%BD%91%E6%98%93.png" alt></p>
<p>以启动场景为例：</p>
<p>首先，Server 会接收到来自用户的启动请求，之后会创建一个分布式锁，Admin 会监控这个锁。</p>
<p>然后， Server 向 Kernel 提交任务，提交之后会立即返回，返回之后就会立即更新数据库中的状态，将状态更新为启动中，这样在页面上用户就能够看到任务是启动中的状态了。</p>
<p>接下来，Server 就会等待内核的 Shell 脚本的执行结果，如果 Shell 脚本执行成功了，就会去写 Zookeeper，写完 Zookeeper 之后 Admin 模块就会马上检测到 Zookeeper 节点有状态发生了修改，Admin 会立即去获取 YARN 上的任务状态，如果获取到任务状态是运行中，就将数据库的任务状态更新为运行中，这会在前端看到任务就已经是运行状态了。</p>
<p>最后一步是 Admin 更为完数据库之后，会释放掉 Zookeeper 上的锁，其他人这时候就可以操作这个任务了。</p>
<p>Server、Kernel 和 Admin 这三个模块都是不可靠的，那么如何保证其稳定和高可用呢？Server 可以通过部署多个，水平扩展来实现，Kernel 则会由 Server 来进行监听，当发现 Kernel 挂了，可以由 Server 重新拉起或者重新创建。而 Admin 的高可用则是通过热备来实现的，如果主 Admin 挂掉了，可以马上迁移到备 Admin，备 Admin 可以迅速将元数据以及任务信息全部加载进来接替工作，进而实现高可用。</p>
<h5 id="平台任务状态管理"><a href="#平台任务状态管理" class="headerlink" title="平台任务状态管理"></a>平台任务状态管理</h5><p>平台的任务状态主要由 Server 和 Admin 来控制。Server 主要控制初始状态的执行，Admin 则主要负责控制所有与 YARN 相关的状态交互。</p>
<p><img src="%E5%B9%B3%E5%8F%B0%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%E5%9B%BE_%E7%BD%91%E6%98%93.png" alt></p>
<h5 id="任务调试"><a href="#任务调试" class="headerlink" title="任务调试"></a>任务调试</h5><p>SQL 类型的任务支持调试功能，用户可以根据不同的 source 表和 dim 表，上传不同的 csv 文件作为输入数据，进行调试。调试执行由指定的 kernel 来完成，sloth-server 负责组装请求，调用 kernel，返回结果，搜集日志。</p>
<p><img src="%E4%BB%BB%E5%8A%A1%E8%B0%83%E8%AF%95_%E7%BD%91%E6%98%93.png" alt></p>
<h5 id="日志检索"><a href="#日志检索" class="headerlink" title="日志检索"></a>日志检索</h5><p>在 YARN 集群的每个节点上面部署 Filebeat，通过 Filebeat 将节点上面的任务日志写入到 Kafka 消息队列中，然后通过 Logstash 进行解析处理，之后写入 ES 集群中。主要用于两个用途，一个是通过界面 Kibana 来提供给开发和运维人员使用，另外一个就是将运行时状态的任务日志直接在界面上展示供用户进行搜索和查看。<br><img src="%E6%97%A5%E5%BF%97%E6%A3%80%E7%B4%A2_%E7%BD%91%E6%98%93.png" alt></p>
<h5 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h5><p>在监控方面，使用的是 influxdb metric report 组件对于指标进行监控。时序数据库使用的是网易自研的 ntsdb 时序数据库，其能够支持动态扩展和高可用等功能。监控指标的使用方式有两种：<br>一种是通过 Grafana 的界面来查看指标；<br>另外一种是报警模块会从Ntsdb中获取相关指标数据并进行监控报警。</p>
<p><img src="%E7%9B%91%E6%8E%A7_%E7%BD%91%E6%98%93.png" alt></p>
<h5 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h5><p>Sloth 流计算平台支持常见的任务失败，数据滞留延迟，failover 报警，也支持用户自定义规则报警，包括对于输入 QPS、输出 QPS，户自定义延迟的监控等。以输入 QPS 为例，可以设置当连续几个周期内 QPS 低于某一值时就触发报警。此外，报警方式也支持多样化的工具，比如各种网易内部的聊天工具、邮件、电话以及短信等，对于任务调试阶段，为了避免被骚扰，可以设置任务报警抑制时间间隔。</p>
<p><img src="%E6%8A%A5%E8%AD%A6_%E7%BD%91%E6%98%93.png" alt></p>
<h5 id="实时数仓"><a href="#实时数仓" class="headerlink" title="实时数仓"></a>实时数仓</h5><p>目前网易很多产品已经开始实时数仓的建设了，但仍旧处于持续完善过程中。实时数仓的建设和离线数仓大致相同，只不过实时数仓是经过实时计算平台进行处理的。大致的过程就是首先收集日志、埋点数据等，将其写入到 Kafka 里面，经过实时计算平台进行处理，将 ODS 层中的明细数据抽取出来，在进行汇总以及维度关联等操作，将结果写入到 Redis，Kudu 等，再通过数据服务提供给前端的业务使用。x</p>
<p><img src="%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93_%E7%BD%91%E6%98%93.png" alt></p>
<h5 id="电商应用-数据分析"><a href="#电商应用-数据分析" class="headerlink" title="电商应用-数据分析"></a>电商应用-数据分析</h5><p>实时活动分析、首页资源分析、流量漏斗以及实时毛利计算等。</p>
<h5 id="电商应用-搜索推荐"><a href="#电商应用-搜索推荐" class="headerlink" title="电商应用-搜索推荐"></a>电商应用-搜索推荐</h5><p>电商的搜索推荐场景则主要包括用户实时足迹、用户实时特征、商品实时特征、实时 CTR CVR 样本组建、首页 A 区轮播、B 区活动精选等 UV、PV 实时统计等。<br>网络营销中的常见名词解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CPC (Cost Per Click): 按点击计费</span><br><span class="line">CPA (Cost Per Action): 按成果数计费</span><br><span class="line">CPM (Cost Per Mille): 按千次展现计费</span><br><span class="line">CVR (Click Value Rate): 转化率，衡量CPA广告效果的指标</span><br><span class="line">CTR (Click Through Rate): 点击率</span><br><span class="line">PV (Page View): 流量</span><br><span class="line">ADPV (Advertisement Page View): 载有广告的pageview流量ADimp (ADimpression): 单个广告的展示次数</span><br><span class="line">PV单价: 每PV的收入，衡量页面流量变现能力的指标</span><br></pre></td></tr></table></figure>

<h2 id="离线数仓与实时数仓"><a href="#离线数仓与实时数仓" class="headerlink" title="离线数仓与实时数仓"></a>离线数仓与实时数仓</h2><h3 id="从0建设离线数仓"><a href="#从0建设离线数仓" class="headerlink" title="从0建设离线数仓"></a>从0建设离线数仓</h3><h4 id="建设数仓"><a href="#建设数仓" class="headerlink" title="建设数仓"></a>建设数仓</h4><p>数据仓库定义：在企业管理和决策中面向主题的、集成的、与时间相关的、不可修改的数据集合。<br>数据仓库目标：数据资产、决策信息。</p>
<ul>
<li>ETL过程：打通你的任督二脉（离线+实时），让数据在整个环节中流通起来</li>
<li>数据分层：一套低耦合、高内聚的层级，是十分重要的，总不想业务、数据等一变化，数仓像又投胎了一次</li>
<li>数据集成：多业务场景下，打破数据信息壁垒，避免数据歧义，统一数据服务</li>
<li>规范化：良好的流程化、规范化设计，易维护、高扩展</li>
<li>监控与辅助：质量监控、调度管理、元数据管理、信息安全管理</li>
<li>走向服务：对外api服务/自助查询平台/OLAP分析平台</li>
</ul>
<h4 id="ETL"><a href="#ETL" class="headerlink" title="ETL"></a>ETL</h4><p>业务数据往往涉及多种数据源，数据存储也常常会有多种选择。文本数据、日志数据、RMDB、Nosql等。则要求etl工具能够覆盖这些业务场景。<br>工具有datax/sqoop/kettle/informatica等等。<br>ETL一般为最开始的部分，凌晨之后的时间点。a：避免集中式的对某个jdbc海量同步，影响业务(部分从库可能提供查询服务)、b：明确调度的时间，应尽可能的在某个时间段内完成(不能仅依靠调度，实现任务流的串行；为后期的大作业空间，占用等待的系统资源)</p>
<h4 id="分层"><a href="#分层" class="headerlink" title="分层"></a>分层</h4><p><img src="%E6%95%B0%E4%BB%93%E5%B8%B8%E7%94%A8%E5%88%86%E5%B1%82.png" alt></p>
<ol>
<li><p>Stage缓冲层<br>事务性数据，每日增量方式进行数据同步。需要注意数据同步时的边界问题，避免脏数据。<br>对于非事务性数据，一般通过快照/全量更新。不对外开放数据查询。</p>
</li>
<li><p>ods层<br>一般场景下，我们认为该层数据与线上保持一致。实际处理过程中，为了处理时间维度上的数据变化，会记录数据的变化轨迹。对于该部分数据，应该有选择的实施，避免业务处理过程变得复杂和问题发生后难以回溯。</p>
</li>
<li><p>dim/dw层 (模型层)<br>dim：维度层<br>dw：主题事实及业务宽表<br>在ods基础上，设计一个宽表/模型层，通过维度建模的方式，实现维度数据与事实数据的分离（星型模型）。</p>
</li>
<li><p>da层（应用层）<br>面向不同的应用，聚合类的数据层。该层对于dim/dw层的使用，是对模型层的一个检视维度。</p>
</li>
</ol>
<h4 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h4><ol>
<li>脚本格式规范：脚本头部注释编码规范、注释规范、sql规范参考goole规范</li>
<li>文件/表命名规范：一个文件中，只应该有一张表，其余只能是临时表；表名称应与文件名相同</li>
<li>字段命名规范：去除多词同义，和同词多义的问题。尤其是在模型层（一般也叫做一致性维度）</li>
</ol>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>离线数仓主要基于sqoop、datax、hive等技术来构建 T+1 的离线数据，通过定时任务每天垃取增量数据导入到hive表中，然后创建各个业务相关的主题，对外提供T+1的数据查询接口。<br>实时数仓主要是基于数据采集工具，如canal等原始数据写入到kafka这样的数据通道中，最后一般都是写入到类似于HBase这样的OLAP存储系统中。对外提供分钟级别，甚至秒级别的查询方案。</p>
<table>
<thead>
<tr>
<th>数仓类型</th>
<th>准确性</th>
<th>实时性</th>
<th>稳定性</th>
</tr>
</thead>
<tbody><tr>
<td>离线数仓</td>
<td>准确度高</td>
<td>时延一般在一天</td>
<td>稳定性好，方便重算</td>
</tr>
<tr>
<td>实时数仓</td>
<td>准确度低，数据延迟、数据乱序造成数据准确度低</td>
<td>分钟级延迟</td>
<td>稳定性差，需要考虑数据回溯处理</td>
</tr>
</tbody></table>
<p><img src="%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A8%A1%E5%9E%8B.png" alt></p>
<p>数据仓库的建设主要包括数据的采集、数据的处理、数据归档、数据应用四个方面。<br>当前主要的应用场景包括报表展示、即席查询、BI展示、数据分析、数据挖掘、模型训练等方面。<br>数据仓库的建设是面向主题的、集成性的、不可更新的、时许变化的。</p>
<p>实时数仓的实施关键点：</p>
<ol>
<li>端到端数据延迟、数据流量的监控</li>
<li>故障的快速恢复能力</li>
<li>数据的回溯处理，系统支持消费指定时间段内的数据</li>
<li>实时数据从实时数仓中查询，T+1数据借助离线通道修正</li>
<li>数据地图、数据血缘关系的梳理</li>
<li>业务数据质量的实时监控，初期可以根据规则的方式来识别质量状况</li>
</ol>
<p>其实，你需要的不是实时数仓，需要的是一款合适且强大的OLAP数据库。<br>在实时数仓的建设中，OLAP数据库的选型直接制约实时数仓的可用性和功能性。</p>
<p>原始层<br>明细层<br>汇总层<br>应用层</p>
<p>ods：原始数据层，事实数据，存储在kafka中<br>dwd：数据明细层，可以做一些join等加宽处理，可以存储在kafka和redis中<br>dim：维度数据，如存储在HBase中的数据<br>dm：MySQL -&gt; 汇总指标模型；Greenplum -&gt; 明细，多维分析关联；HBase -&gt; 汇总指标(大量并发)；Redis -&gt; 汇总、大列表TopN</p>
<pre><code>RPS (Revenue Per Search): 每搜索产生的收入，衡量搜索结果变现能力指标</code></pre><p>　  ROI： 投资回报率（ROI）是指通过投资而应返回的价值，它涵盖了企业的获利目标。利润和投入的经营所必备的财产相关，因为管理人员必须通过投资和现有财产获得利润。又称会计收益率、投资利润率。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/miaowenting.gitee.io/2020/03/23/数据结构和算法/" rel="next" title="数据结构和算法">
                <i class="fa fa-chevron-left"></i> 数据结构和算法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/miaowenting.gitee.io/images/2.JPG" alt="miaowenting">
            
              <p class="site-author-name" itemprop="name">miaowenting</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/miaowenting.gitee.io/archives/">
              
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/miaowenting.gitee.io/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/miaowenting.gitee.io/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/miaowenting" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ci.apache.org/projects/flink/flink-docs-stable/" title="flink文档" target="_blank">flink文档</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href title="flink社区" target="_blank">flink社区</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#离线平台"><span class="nav-number">1.</span> <span class="nav-text">离线平台</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#苏宁"><span class="nav-number">1.1.</span> <span class="nav-text">苏宁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他"><span class="nav-number">1.2.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据治理"><span class="nav-number">1.2.1.</span> <span class="nav-text">数据治理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据质量"><span class="nav-number">1.2.2.</span> <span class="nav-text">数据质量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#血缘"><span class="nav-number">1.2.3.</span> <span class="nav-text">血缘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#元数据管理"><span class="nav-number">1.2.4.</span> <span class="nav-text">元数据管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#资产标签"><span class="nav-number">1.2.5.</span> <span class="nav-text">资产标签</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据安全"><span class="nav-number">1.2.6.</span> <span class="nav-text">数据安全</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实时平台"><span class="nav-number">2.</span> <span class="nav-text">实时平台</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实时接入"><span class="nav-number">2.1.</span> <span class="nav-text">实时接入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实时计算"><span class="nav-number">2.2.</span> <span class="nav-text">实时计算</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#美团点评"><span class="nav-number">2.2.1.</span> <span class="nav-text">美团点评</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bilibili"><span class="nav-number">2.2.2.</span> <span class="nav-text">bilibili</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#场景"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">场景</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#网易"><span class="nav-number">2.2.3.</span> <span class="nav-text">网易</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#事件管理"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">事件管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#平台任务状态管理"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">平台任务状态管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#任务调试"><span class="nav-number">2.2.3.3.</span> <span class="nav-text">任务调试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#日志检索"><span class="nav-number">2.2.3.4.</span> <span class="nav-text">日志检索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#监控"><span class="nav-number">2.2.3.5.</span> <span class="nav-text">监控</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#报警"><span class="nav-number">2.2.3.6.</span> <span class="nav-text">报警</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实时数仓"><span class="nav-number">2.2.3.7.</span> <span class="nav-text">实时数仓</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#电商应用-数据分析"><span class="nav-number">2.2.3.8.</span> <span class="nav-text">电商应用-数据分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#电商应用-搜索推荐"><span class="nav-number">2.2.3.9.</span> <span class="nav-text">电商应用-搜索推荐</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#离线数仓与实时数仓"><span class="nav-number">3.</span> <span class="nav-text">离线数仓与实时数仓</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#从0建设离线数仓"><span class="nav-number">3.1.</span> <span class="nav-text">从0建设离线数仓</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#建设数仓"><span class="nav-number">3.1.1.</span> <span class="nav-text">建设数仓</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ETL"><span class="nav-number">3.1.2.</span> <span class="nav-text">ETL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分层"><span class="nav-number">3.1.3.</span> <span class="nav-text">分层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码规范"><span class="nav-number">3.1.4.</span> <span class="nav-text">代码规范</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#区别"><span class="nav-number">3.2.</span> <span class="nav-text">区别</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">miaowenting</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/miaowenting.gitee.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/miaowenting.gitee.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/miaowenting.gitee.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/miaowenting.gitee.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/miaowenting.gitee.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/miaowenting.gitee.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/miaowenting.gitee.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/miaowenting.gitee.io/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/miaowenting.gitee.io/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/miaowenting.gitee.io/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/miaowenting.gitee.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/miaowenting.gitee.io/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
